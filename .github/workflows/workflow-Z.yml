name: Workflow Z - Auto Update Workflow X References

on:
  push:
    paths:
      - '.github/workflows/workflow-X.yml'
    branches:
      - main
  workflow_dispatch:
    inputs:
      target_org:
        description: 'Organization to scan for repositories (repositories must start with "SHA-Test")'
        required: false
        default: 'AshishGodse'

jobs:
  update-references:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout common repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set TARGET_ORG
        id: set_org
        run: |
          if [ -z "${{ github.event.inputs.target_org }}" ]; then
            TARGET_ORG="AshishGodse"
          else
            TARGET_ORG="${{ github.event.inputs.target_org }}"
          fi
          echo "target_org=${TARGET_ORG}" >> $GITHUB_OUTPUT
          echo "Using organization: ${TARGET_ORG}"
        shell: bash

      - name: Get new commit hash
        id: hash
        run: |
          NEW_HASH=$(git rev-parse HEAD)
          echo "new_hash=${NEW_HASH}" >> $GITHUB_OUTPUT
          echo "New commit hash: ${NEW_HASH}"
        shell: bash

      - name: Fetch all organization repositories
        id: fetch_all_repos
        env:
          TARGET_ORG: ${{ steps.set_org.outputs.target_org }}
          GH_TOKEN: ${{ secrets.WORKFLOW_Z_TOKEN }}
        run: |
          set -euo pipefail
          echo "Fetching ALL repositories from organization: $TARGET_ORG"
          rm -f all_repos.txt || true
          touch all_repos.txt
          
          gh repo list $TARGET_ORG \
            --limit 1000 \
            --archived=false \
            --json name \
            --jq '.[] | .name' >> all_repos.txt
          
          echo "âœ… Repositories fetched successfully"
        shell: bash

      - name: Print all repositories found
        run: |
          echo "=========================================="
          echo "ðŸ“‹ ALL Repositories in organization:"
          echo "=========================================="
          if [ -f all_repos.txt ]; then
            cat -n all_repos.txt
            echo ""
            echo "Total repositories found: $(wc -l < all_repos.txt)"
          else
            echo "No repositories found!"
          fi
          echo "=========================================="
          echo ""
        shell: bash

      - name: Filter repositories starting with "SHA-Test"
        run: |
          echo "=========================================="
          echo "ðŸ” Filtering repositories starting with 'SHA-Test'"
          echo "=========================================="
          rm -f repos.txt || true
          touch repos.txt
          
          if [ -f all_repos.txt ]; then
            while read -r repo; do
              if [[ "$repo" == SHA-Test* ]]; then
                echo "$repo" >> repos.txt
                echo "âœ… Added: $repo"
              fi
            done < all_repos.txt
          fi
          
          echo ""
          echo "=========================================="
          echo "ðŸ“‹ Repositories to be processed (SHA-Test*):"
          echo "=========================================="
          if [ -f repos.txt ] && [ -s repos.txt ]; then
            cat -n repos.txt
            echo ""
            echo "Total repositories to process: $(wc -l < repos.txt)"
          else
            echo "No repositories matching 'SHA-Test*' found!"
          fi
          echo "=========================================="
          echo ""
        shell: bash

      - name: Parse and process repos (scan all workflow files and update workflow-X.yml@<old_hash>)
        env:
          NEW_HASH: ${{ steps.hash.outputs.new_hash }}
          GH_TOKEN: ${{ secrets.WORKFLOW_Z_TOKEN }}
          TARGET_ORG: ${{ steps.set_org.outputs.target_org }}
        run: |
          set -euo pipefail
          NEW_HASH_SHORT=${NEW_HASH:0:8}
          echo "Starting processing with NEW_HASH: $NEW_HASH (short: $NEW_HASH_SHORT)"
          mkdir -p temp
          
          if [ ! -f repos.txt ] || [ ! -s repos.txt ]; then
            echo "No repos.txt found or repos.txt is empty. Nothing to do."
            exit 0
          fi

          while read -r repo || [ -n "$repo" ]; do
            [ -z "$repo" ] && continue
            echo "=========================================="
            echo "Processing repository: $repo"
            echo "=========================================="

            rm -rf temp/"$repo"
            echo "Cloning repository: $TARGET_ORG/$repo"
            git clone --depth=1 https://x-access-token:$GH_TOKEN@github.com/$TARGET_ORG/$repo.git temp/"$repo" || { echo "Failed to clone $repo, skipping"; continue; }

            pushd temp/"$repo" >/dev/null

            if [ ! -d ".github/workflows" ]; then
              echo "No .github/workflows directory in $repo. Skipping."
              popd >/dev/null
              continue
            fi

            changed=false

            while IFS= read -r -d '' wf; do
              echo "Checking workflow file: $wf"
              old_hashes=$(grep -oP 'workflow-X\.yml@\K[a-f0-9]{40}' "$wf" || true)
              if [ -z "$old_hashes" ]; then
                echo "  No workflow-X reference found in $wf"
                continue
              fi

              echo "$old_hashes" | sort -u | while read -r old_hash; do
                if [ -z "$old_hash" ]; then
                  continue
                fi
                echo "  Found reference: workflow-X.yml@$old_hash"
                if [ "$old_hash" = "$NEW_HASH" ]; then
                  echo "  Already up-to-date in this file."
                  continue
                fi
                echo "  Replacing $old_hash -> $NEW_HASH in $wf"
                sed -E -i "s/${old_hash}/${NEW_HASH}/g" "$wf"
                changed=true
              done
            done < <(find .github/workflows -type f \( -name '*.yml' -o -name '*.yaml' \) -print0)

            if [ "$changed" = false ]; then
              echo "No workflow-X references updated in $repo. Cleaning up and moving on."
              popd >/dev/null
              continue
            fi

            git config user.email "automation@github.com"
            git config user.name "Automation Bot"

            echo ""
            echo "=========================================="
            echo "ðŸŒ¿ BRANCH CREATION SECTION"
            echo "=========================================="
            branch_name="update-workflow-x-${NEW_HASH_SHORT}"
            echo "ðŸ“ Branch name to be created: $branch_name"
            echo "â³ Creating new branch..."
            git checkout -b "$branch_name"
            echo "âœ… Branch created successfully"
            echo ""

            git add .github/workflows || true
            if git diff --cached --quiet; then
              echo "No changes staged after replacement, skipping commit."
              popd >/dev/null
              continue
            fi

            echo "ðŸ“ Committing changes to branch: $branch_name"
            git commit -m "chore: update workflow-x reference to ${NEW_HASH_SHORT}"
            echo "âœ… Commit created successfully"
            echo ""

            echo "=========================================="
            echo "ðŸ“¤ PUSH SECTION"
            echo "=========================================="
            echo "â³ Pushing branch to origin: $branch_name"
            git push https://x-access-token:$GH_TOKEN@github.com/$TARGET_ORG/$repo.git "$branch_name"
            echo "âœ… Branch pushed to origin successfully"
            echo ""

            echo "=========================================="
            echo "ðŸ”€ PULL REQUEST CREATION SECTION"
            echo "=========================================="
            echo "ðŸ“‹ Pull Request Details:"
            echo "   Repository: $TARGET_ORG/$repo"
            echo "   Source Branch: $branch_name"
            echo "   Target Branch: main"
            echo "   Title: chore: update workflow-x reference to ${NEW_HASH_SHORT}"
            echo ""
            echo "â³ Creating Pull Request..."
            if gh pr create --repo "$TARGET_ORG/$repo" \
              --title "chore: update workflow-x reference to ${NEW_HASH_SHORT}" \
              --body "Automated update for workflow-x commit reference to ${NEW_HASH_SHORT}" \
              --head "$branch_name" \
              --base main; then
              echo "âœ… Pull Request created successfully"
            else
              echo "âš ï¸ Pull Request creation failed, but branch was pushed successfully"
            fi
            echo ""

            popd >/dev/null

            echo "=========================================="
            echo "âœ… Completed processing $repo"
            echo "=========================================="
            echo ""
          done < repos.txt

          echo "=========================================="
          echo "âœ… All repositories processed (where applicable)"
          echo "=========================================="
        shell: bash

      - name: Cleanup temp directory
        if: always()
        run: |
          rm -rf temp || true
          rm -f all_repos.txt || true
          rm -f repos.txt || true
        shell: bash