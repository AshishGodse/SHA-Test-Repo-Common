name: Workflow Z - Auto Update Workflow X References

on:
  push:
    paths:
      - '.github/workflows/workflow-X.yml'
    branches:
      - main
  workflow_dispatch:

jobs:
  update-references:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout common repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get new commit hash
        id: hash
        run: |
          NEW_HASH=$(git rev-parse HEAD)
          echo "new_hash=${NEW_HASH}" >> $GITHUB_OUTPUT
          echo "New commit hash: ${NEW_HASH}"

      - name: List all repositories to process
        run: |
          echo "=========================================="
          echo "üìã Repositories to be processed:"
          echo "=========================================="
          grep "name:" .github/repos-config.yml | grep -v "#" | awk '{print "  - " $NF}'
          echo "=========================================="
          echo ""
        shell: bash

      - name: Parse and process repos
        env:
          NEW_HASH: ${{ steps.hash.outputs.new_hash }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=========================================="
          echo "üîÑ Starting repository update process"
          echo "=========================================="
          echo ""
          
          # Extract repo names from config using grep and awk
          repos=$(grep "name:" .github/repos-config.yml | grep -v "#" | awk '{print $NF}')
          
          for repo in $repos; do
            echo "=========================================="
            echo "Processing repository: $repo"
            echo "=========================================="
            
            # Get workflow file for this repo using grep
            workflow_file=$(grep -A 2 "name: $repo" .github/repos-config.yml | grep "workflow_file:" | awk '{print $NF}')
            
            if [ -z "$workflow_file" ]; then
              echo "‚ùå Workflow file not found for $repo"
              continue
            fi
            
            echo "‚úÖ Workflow file: $workflow_file"
            
            # Clone repository with token
            echo "üì• Cloning repository: $repo"
            git clone https://x-access-token:$GH_TOKEN@github.com/AshishGodse/$repo.git temp/$repo
            
            # Extract old hash from workflow file
            old_hash=$(grep -oP 'workflow-X\.yml@\K[a-f0-9]{40}' temp/$repo/$workflow_file 2>/dev/null || echo "")
            
            if [ -z "$old_hash" ]; then
              echo "‚ùå No workflow-X reference found in $repo"
              continue
            fi
            
            echo "üìå Current hash in $repo: $old_hash"
            echo "üìå New hash from common repo: $NEW_HASH"
            
            if [ "$old_hash" == "$NEW_HASH" ]; then
              echo "‚úÖ Hash already up-to-date in $repo"
              echo ""
              continue
            fi
            
            echo "üîÑ Updating $repo: $old_hash -> $NEW_HASH"
            
            # Update workflow file
            cd temp/$repo
            sed -i "s/${old_hash}/${NEW_HASH}/g" $workflow_file
            
            # Configure git
            git config user.email "automation@github.com"
            git config user.name "Automation Bot"
            
            # Create branch and commit
            branch_name="update-workflow-x-${NEW_HASH:0:8}"
            echo "üåø Creating branch: $branch_name"
            git checkout -b $branch_name
            git add $workflow_file
            git commit -m "chore: update workflow-x reference to ${NEW_HASH:0:8}"
            
            # Push branch with token auth
            echo "üì§ Pushing branch to origin"
            git push https://x-access-token:$GH_TOKEN@github.com/AshishGodse/$repo.git $branch_name
            
            # Create PR
            echo "üìù Creating Pull Request"
            gh pr create \
              --title "chore: update workflow-x reference to ${NEW_HASH:0:8}" \
              --body "Automated update for workflow-x commit reference\n\nOld hash: $old_hash\nNew hash: $NEW_HASH\n\nThis PR was automatically created by Workflow Z" \
              --base main \
              --head $branch_name || echo "‚ö†Ô∏è PR creation might have issues but branch is pushed"
            
            cd ../..
            echo "‚úÖ Completed processing $repo"
            echo ""
          done
          
          echo "=========================================="
          echo "‚úÖ All repositories processed successfully"
          echo "=========================================="
        shell: bash